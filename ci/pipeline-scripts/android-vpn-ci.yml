.android-vpn-job-configuration:
  image: irdest/android-build-env:latest
  script:
    - pwd
    - cd clients/android-vpn
    - chmod +x gradlew
  only:
    changes:
      - clients/android-vpn/**/*
  cache:
    key: ${CI_PROJECT_ID}
    paths:
      - clients/android-vpn/.gradle/

# Compile rust library
cross-compile-android-vpn:
  stage: build
  extends: .android-vpn-job-configuration
  script:
    - ./gradlew cargoBuild
    - mkdir result-android-vpn && cp -r app/src/main/jniLibs/* result-android-vpn/ 
  artifacts:
    name: "android-vpn-ratman-library"
    paths:
      - clients/android-vpn/result-android-vpn/*

# Build android deBug.apk
build-android-vpn:
  stage: build
  extends: .android-vpn-job-configuration
  script:
    - ./gradlew assembleDebug
    - mkdir result-android-vpn && cp app/build/outputs/apk/debug/app-debug.apk result-android-vpn/irdest-vpn-debug.apk
  artifacts:
    name: "android-vpn-apk"
    paths:
      - clients/android-vpn/result-android-vpn/*

# Check linting
lint-androd-vpn:
  stage: lint 
  extends: .android-vpn-job-configuration
  script:
    - ./gradlew -Pci --console=plain :app:lintDebug -PbuildDir=lint

# Run all tests, do not interrupt the pipeline 
test-android-vpn:
  stage: test
  extends: .android-vpn-job-configuration
  script:
    - ./gradlew -Pci --console=plain :app:testDebug